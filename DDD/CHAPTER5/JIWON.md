# Chapter 5. Spring Data JPA를 이용한 조회 기능

---

## CQRS?

---

CQRS는 명령(Command) 모델과 조회(Query) 모델을 분리하는 패턴이다.

명령 모델: 상태를 변경하는 기능을 구현할 때 사용

조회 모델: 데이터를 보여주는 기능을 구현할 때 사용

엔티티, 애그리거트, 리포지토리 등의 모델은 상태를 변경할 때 주로 사용한다.

→ 도메인 모델은 주로 명령으로 사용 됨

정렬, 페이징, 검색 조건 지정과 같은 기능은 조회 모델에서 사용된다.

## 검색을 위한 스펙

---

검색은 다양한 조건을 조합해야 하는 경우가 많다.

→ 검색 조건을 다양하게 조합해야 할 때 사용하는 것이 **스펙**이다.

스펙: 애그리거트가 특정 조건을 충족하는지를 검사할 때 사용하는 인터페이스

```java
public interface Speficiation<T> {
		boolean isSatisfiedBy(T agg); // 검사 대상 객체가 조건을 충족하면 true를 리턴하는 메서드
}
```

agg 파라미터: 검사 대상이 되는 객체

리포지토리나 DAO는 검색 대상을 걸러내는 용도로 스펙을 사용

**실제 스펙이 이렇게 구현되지 않는다.**

→ 모든 애그리거트 객체를 메모리에 보관하기 어렵고(OOM), 다 보관하더라도 조회 성능에 심각한 이슈를 발생시킨다.

## Spring Data JPA의 스펙 구현

---

Spring Data JPA는 검색 조건을 표현하기 위한 인터페이스인 `Specification`을 제공한다.

```java
public interface Specification<T> extends Serializable {}
```

T는 JPA의 엔티티 타입, `toPredicate()` 메서드는 Criteria API 조건을 표현하는 Predicate 생성

책 178 - 181 사용 예시 확인해보기

## 레포지토리, DAO에서 스펙 사용하기

---

`JpaRepository` 또는 `Repository` 를 상속받는 DAO 인터페이스를 생성하고 여기에 스펙을 파라미터로 받는 메서드를 선언하면 된다.

→ 스펙 구현체를 사용하여 특정 조건을 충족하는 엔티티를 검색할 수 있다.

스펙 인터페이스는 함수형 인터페이스이므로 스펙 생성 기능을 별도의 클래스에 모을 수 있다.

## 스펙 조합

---

스펙은 `and()`, `or()` 메서드로 조합할 수 있다.

→ `and()` , `or()` 는 기본 구현을 가진 디폴트 메서드

## 정렬 지정하기

---

Spring Data JPA는 2가지 정렬 방식을 제공한다.

- 메서드 이름에 `OrderBy` 사용해서 정렬 기준 지정 → 여러 조건을 줄 수 있다.
    - 메서드 이름이 길어지는 단점이 있다.
- `Sort`를 인자로 전달
    - Sort.by(”타겟”).descending()과 같이 사용해서 파라미터로 전달하면 된다.
    - `and()` 메서드로 체이닝 가능하다.

## 페이징 처리하기

---

`Pageable` 인터페이스를 파라미터로 두어 페이징 처리할 수 있다.

`PageRequest` 구현체를 파라미터로 전달해주면 된다.

```java
PageRequest.of(1, 2, sort);
// 첫 번째 인자: 페이지 번호, 두 번째 인자: 가져올 데이터 개수, 세 번째 파라미터: 정렬 조건
```

 `Page` 타입으로 메서드를 리턴하는 경우 데이터 목록과 함께 여러 데이터를 같이 받을 수 있다.

## 스펙 조합을 위한 스펙 빌더 클래스

---

스펙을 조합해서 써야되는 경우 스펙 빌더를 활용할 수 있다.

`SpecBuilder.builder(Target.class)`로 메서드 체이닝 하면 된다.

`and()`, `ifHasText()`, `ifTure()` 메서드가 존재

## 동적 인스턴스 생성

---

쿼리 결과를 임의의 객체로 동적으로 생성할 수 있는 기능 제공

→ **Projection**

**프로젝션 하고자 하는 클래스에 쿼리에 넣어준 생성자가 존재해야 된다.**

Querydsl로 프로젝션하는게 더 편함

## 하이버네이트 @Subselect 사용

---

하이버네이트는 JPA 확장 기능으로 `@Subselect`를 제공한다.

쿼리 결과를 `Entity`로 매핑할 수 있는 유용한 기능

`@Immutable`, `@Subselect`, `@Synchronize` 를 활용하여 테이블이 아닌 쿼리 결과를 엔티티로 매핑 가능

`@Subselect` : 조회 쿼리를 value로 가진다.

`@Immutable` : subselect로 조회한 엔티티의 수정을 방지한다.

`@Synchronize` : DB와 영속성 컨텍스트 싱크를 맞춰준다.
