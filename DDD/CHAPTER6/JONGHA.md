# 6장 응용 서비스와 표현 영역

# 표현영역과 응용 영역

- 사용자에게 기능을 제공하려면, 도메인과 사용자를 연결해 줄 표현 영역과 응용영역이 필요하다.
- 표현 영역
    - 사용자의 요청을 해석하고, 사용자가 실행하고 싶은 기능 판별 및 응용서비스 실행
    - 응용 서비스가 요구하는 형식으로 사용자 요청 변환
- 응용 영역
    - 사용자가 원하는 기능을 제공
    - 기능 실행에 필요한 입력 값을 받고, 실행 결과 리턴

# 응용 서비스의 역할

- 도메인 영역과 표현 영역을 연결해주는 창구, 응용 서비스는 **도메인 객체 간의 흐름을 제어하기 때문에 다음과 같이 단순한 형태를 가진다.**
- 응용 서비스가 복잡하다면, 응용서비스에서 도메인 로직의 일부를 구현하고 있을 가능성이 높다.
- 트랜젝션 처리를 담당한다.
- 접근 제어와 이벤트 처리를 한다.
- 도메인 로직을 넣으면 안된다.
    - 코드의 응집성이 떨어진다. → 로직이 서로 다른 영역에 위치하여 여러 영역을 분석해야 함
    - 여러 응용서비스에서 동일한 도메인 로직을 구현할 가능성이 높다.  → 코드 변경을 어렵게 만든다.

# 응용 서비스의 구현

- 표현 영역과 도메인 영역을 연결한다. 디자인 패턴의 파사드와 같은 역할.
- 응용 서비스 구현
    - 한 응용 서비스 클래스에 회원 도메인의 모든 기능 구현
        - 장점 : 동일한 로직을 위한 코드 중복 제거 쉽다.
        - 단점 : 한 서비스 클래스 크기 커진다. → 연관성 적은 코드가 들어갈 가능성 높아짐.
    - 구분 되는 기능 별로 응용 서비스 클래스 따로 구현
        - 단점 : 동일한 로직 → 별도 클래스로 구현하여 코드 중복 막는다.
        - 장점 : 코드 품질을 일정 수준 유지할 수 있다.
- 구분 되는 기능을 별도의 응용서비스 클래스로 구현하는 것이 낫다.

```java
// 공통 로직 별도 클래스로 구현
public final class MemberHelper {
	
	public static Member findExistingMember(MemberRepository repo, String memberId) {
		Member member = repo.findById(memberId);
		if (member == null) {
			throw new NoMemberException();
		}
		return member;
	}
}

// 공통 로직을 제공하는 메서드를 응용 서비스에서 사용
public class ChangePasswordService {

	private final MemberRepository memberRepository;

	public void changePassword(String memberId, String curPw, String newPw) {
		Member member = MemberHelper.findExistingMember(memberRepository, memberId);
		member.changePassword(curPw, newPw);	
	}
}
```

- 응용 서비스와 인터페이스
    - 응용서비스는 런타임에 교체되는 경우 거의 없다.
    - TDD 진행 방식에 따라 응용서비스 인터페이스 필요 여부가 달라진다.
- 응용서비스의 메서드 파라미터와 값 리턴
    - 요청 파라미터 두개 이상이면, 데이터 전달을 위한 별도 클래스 사용
    - 표현 영역에서 필요한 데이터만 리턴하여 기능 실행 로직의 응집도를 높이다.
- 표현 영역에 의존하지 않는다. `HttpServletRequest`, `HttpSesssion` 등 컨트롤러에 사용되는 타입을 응용 서비스로 넘기면 안된다.

# 표현 영역

- 사용자가 시스템을 사용할 수 있도록 알맞은 흐름을 제공
- 사용자의 요청에 맞게 응용 서비스에 기능 실행 요청
- 사용자이 연결 상태인 세션을 관리한다.
    - 웹은 쿠키나 서버 세션을 이용하여 사용자의 연결 상태를 관리한다.
    - 권한 검사와도 연결

# 값 검증

- 표현 영역와 응용 서비스 두곳에서 수행 가능
- 스프링 mvc는 입력된 값이 잘못된 경우, 에러 메시지를 보여주기 위한 용도로 Errors나 BindingResult 사용
- 응용 서비스에서 사용할 경우, 에러 코드를 모아 하나의 익셉션으로 발생.
- 표현 영역에서도 값 검증할 수 있음.
- 스프링에서는 Validator 인터페이스 별도 제공
- 따라서 다음과 같이 나눠서 진행
    - 표현 영역 : 필수 값, 값의 형식, 범위 등 검증
    - 응용 서비스 : 데이터의 존재 유무와 같은 논리적 오류 검증
    - 최근에는 응용서비스에서 값 오류도 검증하는 편

# 권한 검사

- 권한 검사 : 사용자 U 가 기능 F를 실행시킬 수 있는지
- 표현 영역, 응용서비스, 도메인에서 검사 가능

## 표현 영역

- 인증된 사용자인지 아닌지 검사
- 서블릿 필터.
- 인증 정보를 생성하고 인증 여부 검사. 인증 여부 뿐만 아니라, url 권한 검사도 가능함.

## 응용서비스

- 메서드 단위의 권한 검사
- 스프링 시큐리티는 AOP 를 활용해서 지원함

```java
@PreAuthorize("hasRole('ADMIN')")
```

[신입 백엔드 개발자 혼돈의 파일럿 프로젝트 돌아보기 (feat.정산플랫폼팀) | 우아한형제들 기술블로그](https://techblog.woowahan.com/7828/#toc-2)

## 개별 도메인

- 객체 단위로 권한 검사
- 직접 권한 검사 로직 구현
- 보안 프레임 워크를 확장하여, 객체 수준의 권한 검사 기능을 프레임 워크에 통합할 수 있지만, 이해도가 높지 않다면 직접 구현하는 것이 코드 유지 보수에 유리

# 조회 전용기능과 응용 서비스

- 서비스에서 추가적 로직이 없다면, 응용 서비스 없이 조회 전용 기능(dao/ 리포지터리) 에 접근해도 된다.
