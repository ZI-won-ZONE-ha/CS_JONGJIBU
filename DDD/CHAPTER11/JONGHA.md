# 11장 CQRS

# 11. 1 단일 모델의 단점

- 문제점
    - select 쿼리 한번으로 조회화면 필요한 데이터 가져오지 못함.
    - DBMS가 제공하는 전용기능 필요하면, JPA의 네이티브 쿼리 사용해야함.
- 시스템 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문
    - 객체 지향의 ORM 기법은 도메인 상태 변경에는 적합하지만, 여러 애그리 거트에서 데이터 가쳐와 출력할 때에는 고려할 게 많아, 구현을 복잡하게 만든다.
- → 상태 변경을 위한 모델과 조회를 위한 모델을 분리한다.

# 11.2 CQRS

- 하나는 상태를변경하는 기능 → 한개의 애그리 거트 변경
- 상태 정보를 조회하는 기능 → 두개이상의 애그리거트가 필요할 떄가 많다.

→ 단일 모델을 사용할 때, 발생하는 복잡도를 해결하기 위해 사용하는 방법으로 CQRS 

- 복잡한 도메인에 적합
- JPA 기반 단일 도메인 모델을 사용하면, 통계 값을 빠르게 조회하기 위해 JPA과 관련된 다양한 성능 관련 기능을 모델에 적용
- 조회는 조회할 때 좋은 mybatis, 객체지향 기반하여, 도메인 모델을 구현하기에 적당한 JPA

- 조회 모델에는 응용서비스가 존재하지 않음
- 명령 모델은 상태를 변경하는 도메인 로직을 수행하는데 초점을 맞춰 설계했고, 조회 모델은 화면에 보여줄 데이터를 조회하는데 초점을 맞춰 설계
- 명령 모델과 조회 모델이 서로 다른 데이터 저장소 사용할 수 있다. 명령 모델을 RDBMS , 조회는 성능 좋은 메모리 기반 NOSQL 을 사용할 수 있다.
    - 이 때, 두 데이터 저장소 간 동기화는 이벤트를 활용한다.
    - 상태 변경 이벤트 → 조회 모델에 전달하여 변경내역 반영
    - 동기 이벤트와 글로벌 트랜젝션 사용하면, 전반적인 성능 떨어짐.
    - 특정 기간 안에만 동기화 하면 되는 통계저장소라면, 비동기로 데이터를 보낼 수 있다.

### 웹과 CQRS

- 캐쉬와 쿼리 최적화를 통해 실행 속도 높이고, 응답 속도 높인다.
    - DB보관된 데이터를 저장하기 보다, 화면에 맞는 모양인 데이터를 캐싱할 때 성능이 유리하다.

### CQRS 장단점

- 장점
    - 명령 모델에서 조회 관련 로직 사라져 복잡도 낮아짐
    - 조회 성능 향상 시킬 수 있다. →
        - 조회 단위로 캐쉬 기술 적용가능
        - 조회 처리량 대폭 늘릴 수 있다.
        - 구현해야 할 코드 많다.
- 단점
    - 구현해야 할 코드가 많다.
    - 도메인 복잡하다면, 조회전용 모델을 만드는 것이 유지 보수에 유리
    - 더많은 구현기술이 필요하다.
        - 다른 저장소 또는 다른 기술
        - 메시지 동기화를 위해 메시징 시스템 도입해야 할 수 있다.
        

→ 결론은 트래픽 높은 서비스일 때 CQRS 도입 고려하자!
