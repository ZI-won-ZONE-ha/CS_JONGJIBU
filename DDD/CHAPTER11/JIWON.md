# Chapter 11. CQRS

---

## 단일 모델의 단점

---

주문 내역 조회 기능을 구현하려면 여러 애그리거트에서 데이터를 가져와야 한다.

→ Order에서 주문 정보, Product에서 상품 정보, Member에서 회원 정보

여러 애그리거트에서 데이터를 가져오는 경우 고려할 사항이 많다.

→ 식별자 참조 이용 시 JPA 즉시 로딩 사용 힘듦, 직접 참조 시 즉시 로딩, 지연 로딩 중 뭘 할지 결정해야된다.

**이런 문제가 발생하는 이유는 조회에도 단일 도메인 모델을 사용하기 때문에 발생한다.**

→ 상태 변경을 위한 모델과 조회를 위한 모델을 분리해야 한다.

## CQRS

---

시스템이 제공하는 기능

1. 상태를 변경하는 기능
2. 상태 정보를 조회하는 기능

도메인 모델 관점에서 상태를 변경하는 기능은 주로 한 애그리거트의 상태를 변경, 상태 정보를 조회하는 기능은 두 개 이상의 애그리거트가 필요

→ **두 기능의 작업 범위가 일치하지 않기 때문에 단일 모델로 두 종류의 기능을 구현하면 모델이 복잡해진다.**

이럴 때 사용하는 것이 CQRS(Command Query Responsibility Segregation)

→ **명령을 위한 모델과 상태를 제공하는 조회 모델을 분리하는 패턴**

CQRS 패턴은 복잡한 도메인에 적합하다. → 명령과 조회 기능이 다루는 데이터 범위 차이가 커지기 때문에

CQRS 패턴을 사용하면 각 모델에 맞는 구현 기술을 사용할 수 있는 장점이 있다. 물론 같은 기술 사용해도 됨

ex) 조회에는 MyBatis, 명령에는 JPA

명령 모델과 조회 모델이 다른 데이터 저장소를 사용할 수도 있다.

ex) 조회에는 NoSQL, 명령에는 RDBMS

이 경우 두 데이터 저장소 사이의 데이터 동기화를 위해 이벤트를 활용해야 한다.

→ 데이터 동기화 시점에 따라 구현 방식은 달라질 수 있다. (즉시 반영: 동기, 특정 시간 안에서 반영: 비동기)

### 웹과 CQRS

일반적인 웹 서비스의 요청은 상태를 조회하는 요청이 훨씬 많다.

개발자들은 빠른 상태 조회를 위해 쿼리 최적화, 캐싱, 조회 전용 저장소 등 여러 기법들을 활용하게 된다.

→ 이렇게 **여러 기법을 적용하는 과정이 결과적으로 CQRS를 적용하는 것과 같은 효과를 준다.**

대규모 트래픽이 발생하는 웹 서비스는 자연스럽게 CQRS를 적용하게 된다.

### CQRS 장단점

CQRS의 장점은 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점이다.

→ 명령 모델과 조회 모델을 분리해두면 도메인 로직을 구현하는데 집중할 수 있음

또 다른 장점은 조회 성능을 끌어올릴 수 있다는 점이다.

→ 조회에 관련된 성능 최적화를 진행할 수 있음 (쿼리 최적화, 캐싱 등)

단점으로는 구햔해야 할 코드가 많아지는 단점이 있다.

→ 도메인이 복잡하다면 유지보수 측면에서 CQRS를 분리하는게 좋지만 복잡하지 않다면 굳이 구현 코드를 늘릴 이유가 없다.

또 다른 단점은 더 많은 구현 기술이 필요하다는 점이다.
