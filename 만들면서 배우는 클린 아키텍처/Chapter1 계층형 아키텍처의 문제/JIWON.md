# 계층형 아키텍처의 문제

## 계층형 아키텍처

개발자는 웹 - 도메인 - 영속성 계층으로 구성되는 전통적인 웹 어플리케이션을 주로 개발한다. 

**계층형 아키텍처는 견고하면서 선택의 폭이 넓어지고 요구사항과 외부 요인에 빠르게 적응할 수 있게 해준다.**

그러나 코드에 나쁜 습관이 스며들기 쉽고, 시간이 지나면서 소프트웨어를 변경하기 어렵게 만드는 요소들이 생긴다.

## 계층형 아키텍처는 데이터베이스 주도 설계를 유도한다.

계층형 아키텍처의 토대는 **데이터베이스**이다. → 의존 관계의 끝이 **영속성 계층**이기 때문

이러한 점이 문제를 발생시킨다.

애플리케이션을 만드는 목적은 **비즈니스를 관장하는 규칙이나 정책을 반영한 모델을 만드는 것**이다.

→ 우리는 상태가 아닌 **행동을 중심으로 모델링**한다. (행동이 비즈니스를 이끌어가기 때문)

→ 하지만 우리는 도메인 로직이 아닌 데이터베이스를 기반으로 아키텍처를 만든다.

의존성의 방향에 따라 자연스럽게 구현하기 때문이다.

그러나 **비즈니스 관점에서는 도메인 로직을 먼저 만드는 것이 올바른 방법이다.**

**데이터베이스 중심적인 아키텍처가 만들어지는 원인은 ORM 프레임워크를 사용하기 때문이다.**

ORM에 의해 관리되는 엔티티들은 일반적으로 영속성 계층에 둔다.

→ **영속성 계층과 도메인 계층 사이에 강한 결합이 발생한다.**

→ **영속성 코드가 사실상 도메인 코드에 녹아들어가서 둘 중 하나만 바꾸는 것이 어려워진다.**

## 지름길을 택하기 쉬워진다.

계층형 아키텍처에서 전체적으로 적용되는 유일한 규칙: **특정 계층에서는 같은 계층 또는 하위의 계층에만 접근 가능하다.**

→ 상위 계층에 위치한 컴포넌트에 접근해야 된다면 컴포넌트를 계층 아래로 내려버릴 수 있음

→ 이런 일이 반복되면 결국에는 영속성 계층이 비대해지는 문제가 발생한다.

→ 아키텍처 규칙이 느슨하기 때문에 일어난 일

## 테스트하기 어려워진다.

계층형 아키텍처를 사용하다보면 계층을 건너뛰게 되는 순간이 있음

→ 처음에는 괜찮을 수 있지만 자주 발생하면 문제 발생 가능

1. 도메인 로직을 웹 계층에서 구현하게 된다.
2. 웹 계층 테스트에서 도메인 계층 + 영속성 계층 모킹 필요함 → 단위 테스트의 복잡성이 증가한다.

## 유스케이스를 숨긴다.

계층형 아키텍처는 새로운 코드(기능 추가, 변경 등)를 작성할 때 적절한 위치를 찾기 어려워진다.

→ 계층형 아키텍처에서 **도메인 로직이 여러 계층에 걸쳐 흩어지기 쉽기 때문에** 이런 상황 발생

도메인 서비스의 너비에 관한 규칙이 없기 때문에 **여러 유스케이스를 포함하는** **커다란 클래스**가 만들어질 수도 있다.

→ **영속성 계층에 많은 의존성을 가지게 되고, 웹 레이어의 많은 컴포넌트가 해당 서비스에 의존한다.**

→ 테스트가 어려워지고 작업해야할 코드를 찾기도 어려워진다.

## 동시작업이 어려워진다.

계층형 아키텍처는 동시 작업에서 그렇게 도움이 되지 않는 구조이다.

계층형 아키텍처는 **영속성 → 도메인 → 웹 계층 순서대로 만들어야 되기 때문에 한 시점에 1명만 작업 가능**

만약 따로 한다고 가정하더라도 결국에 데이터베이스 주도 설계를 해야되기 때문에 사실상 불가능

**넓은 서비스에 여러 개발자가 다른 기능을 개발할 경우 머지 충돌 가능**

## 유지보수가 가능한 소프트웨어

추가적인 규칙을 적용하여 유지보수를 쉽게 만들어야 한다.
