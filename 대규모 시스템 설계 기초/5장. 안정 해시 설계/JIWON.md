# 5장. 안정 해시 설계

---

요청, 데이터를 서버마다 균등하게 나눠야 스케일 아웃이 효과가 있다.

안정 해시를 균등한 요청 배분을 위해 사용되는 보편적인 방법이다.

## 해시 키 재배치 문제

---

N개의 캐시 서버에 부하를 균등하게 나누는 보편적인 방법은 해시 함수를 사용하는 것

`serverIndex = hash(key) % N (N = 서버의 개수)`

이러한 방법은 **서버 풀의 크기가 고정되어 있는 경우, 데이터 분포가 균등할 때 효과적이다.**

→ 서버가 추가되거나 삭제되는 경우 문제가 생긴다.

→ N이 변하기 때문에 키를 재배치해야 되고 이로 인해 문제가 발생함

→ 대규모 캐시 미스가 발생할 수 있다.

## 안정 해시

---

**안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 k / n개의 키만 재배치하는 해시 기술 (k = 키의 개수, n = 서버의 개수)**

### 해시 공간과 해시 링

해시함수는 SHA-1을 사용한다.

→ 출력 값의 범위는 x0 ~ xn이고 0 ~ 2^160 - 1의 값을 가진다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/ff946243-b57b-4d42-a5b7-04d05c65d822)

이러한 해시 공간을 원형으로 만들면 다음과 같은 해시 링이 만들어진다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/3ab4b6a2-49be-4806-8a33-a22e60753a74)

### 해시 서버

해시 함수 f를 사용하면 서버 IP나 이름을 이 링의 어떤 위치에 대응시킬 수 있다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/d8c2bf64-3697-495e-a2c9-bb902e9ab1e0)

### 해시 키

현재 사용하는 해시 함수는 % 연산을 사용하고 있지 않다.

캐시할 키도 해시 링에 배치할 수 있다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/09958d9c-392b-4f93-9e07-56b1b0d3befb)

### 서버 조회

어떤 키가 저장되는 서버는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버이다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/3b9f9b5a-e154-43fe-a3b9-cc73f22e4696)

### 서버 추가

서버가 추가되더라도 키 가운데 일부만 재배치하면 된다.

→ 나머지 키에는 영향을 안준다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/94ff59f3-d2af-494e-bd71-6f00c79ef79c)

### 서버 제거

하나의 서버가 제거되더라도 키 가운데 일부만 재배치하면 된다.

→ 나머지 키에는 영향을 안준다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/126e1020-102d-451b-b7b2-8d4a3786dcef)

### 기본 구현법의 두 가지 문제

- 서버가 추가되거나 삭제되는 상황에서 파티션의 크기를 균등하게 유지하는 것이 어렵다.
- 키의 균등 분포를 달성하기 어렵다.

이런 문제를 해결하기 위해 가상 노드 또는 복제라 불리는 기법이 등장하였다.

### 가상 노드

가상 노드는 실제 노드 또는 서버를 가리키는 노드

하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/ec134f7e-2605-40c8-823e-7eb4e95f2fe3)

이런식으로 가상 노드를 배치하여 서버가 하나의 파티션이 아닌 여러 파티션을 관리하도록 설정한다.

**키의 위치로부터 시계 방향 탐색을 하다 만나는 최초의 가상 노드가 해당 키의 서버가 된다.**

**가상 노드의 개수를 늘리면 키의 분포가 점점 균등해짐 → 표준 편차가 작아지기 때문에**

다만 가상 노드에게 할당되는 공간이 늘어나는 trade-off가 존재하기 때문에 잘 맞춰줘야 한다.

### 재배치할 키 결정

서버 추가, 삭제에 따른 재배치 방식은 동일하다.

## 마치며

---

안정 해시의 이점

- 서버가 추가 또는 삭제될 때 재배치되는 키의 수가 최소화
- 데이터가 보다 균등하게 분포하므로 스케일 아웃의 확장성을 달성하기 좋음
- 핫스팟 키 문제를 줄여준다. → 데이터를 조금 더 균등하게 분배하므로

안정 해시를 사용하는 것들

- 아마존 다이나모 DB의 파티셔닝 관련 컴포넌트
- 아파치 카산드라 클러스터의 데이터 파티셔닝
- 디스코드
- 아카마이 CDN
- 메그레프 네트워크 부하 분산기
