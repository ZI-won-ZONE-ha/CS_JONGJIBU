# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

---

분산 시스템에서 사용하는 ID 생성기는 기존의 RDB에서 지원하는 auto_increment로는 해결할 수 없다.

→ 하나의 서버가 요구 사항을 감당할 수 없고 지연 시간을 낮추기가 매우 어렵기 때문에

이를 위해 분산 시스템에서 ID 생성기를 어떻게 설계해야 될지 알아보자

## 문제 이해 및 설계 범위 확장

---

ID 생성기로 생성되는 ID가 어떤 특징을 가지고 어떻게 생성해야 되는지를 파악해야 한다.

- ID는 유일해야 한다.
- ID는 숫자로만 구성되어야 한다.
- ID는 64bit로 표현될 수 있는 값이어야 한다.
- ID는 발급 날짜에 따라 정렬 가능해야 한다.
- 초당 10,000개의 ID를 만들 수 있어야 한다.

MySQL의 클러스터링 인덱스를 고려한 설계인거 같다.

## 개략적 설계안 제시 및 동의 구하기

---

분산 시스템에서 유일성이 보장되는 ID를 만드는 방법은 여러가지 존재

### 다중 마스터 복제 (multi-master replication)

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/a629b58e-8090-429d-accc-320c8c69fe05)

DB의 auto_increment 기능을 활용하는 방식

**다음 ID 값을 구할 때 1을 증가시키는 것이 아닌 사용중인 데이터베이스 서버의 개수만큼 증가시키는 방법이다.**

단점은 다음과 같다.

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어려움
- ID의 유일성은 보장되지만 값이 시간 흐름에 맞춰 커지도록 보장할 수 없음
- 서버를 추가하거나 삭제할 때 잘 동작하도록 만들기 어려움

### UUID

UUID는 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128bit 수

충돌 가능성이 매우 낮음

→ 서버 간 조율 없이 독립적으로 생성 가능하다는 장점이 있다.

장점

- UUID를 만드는 것은 단순하고 서버 사이의 조율이 필요 없어 동기화 이슈 없음
- 각 서버가 자신이 사용할 ID를 만드는 구조이기 때문에 규모 확장이 쉽다.

단점

- ID가 128bit으로 길다
- ID가 랜덤으로 생성되기 때문에 시간순으로 정렬할 수 없다.
- ID에 숫자가 아닌 값이 포함될 수 있다.

### 티켓 서버

티켓 서버를 활용하여 유일성이 보장되는 ID를 만들어 제공할 수 있다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/04b09dd8-a35e-4dde-a677-52ccd5977f29)

**티켓 서버를 중앙 집중형으로 하나만 사용한다!**

장점

- 유일성이 보장되는 오직 숫자로만 구성된 ID를 쉽게 만들 수 있다.
- 구현하기 쉽고, 중소 규모 Application에 적합하다.

단점

- **티켓 서버가 중앙 집중형으로 하나이기 때문에 단일 장애 지점이 될 수 있음**

### 트위터 스노플레이크 접근법

트위터는 스노플레이크라는 ID 생성 기법을 활용한다.

![image](https://github.com/ZI-won-ZONE-ha/CS_JONGJIBU/assets/88527476/fd6cf515-d29d-4c0f-8cf6-21cadce41ec4)

- 사인 비트: 1비트 할당 → 당장 쓰임새는 없지만 추후를 위해 설계된 비트
- 타임 스탬프: 기원 시각 후 몇 밀리초가 경과했는지 저장하는 필드
- 데이터 센터 ID: 5bit → 2^5 = 32개의 데이터 센터를 지원한다.
- 서버 ID: 데이터 센터 ID와 마찬가지로 데이터 센터 당 32개의 서버를 지원한다.
- 일련번호: 각 서버가 ID를 생성할 때마다 일련번호를 1씩 증가시켜 저장한다. → 1밀리초가 지날때마다 0으로 재초기화

## 상세 설계

---

데이터센터 ID, 서버 ID는 시스템이 시작할 때 결정되고 바뀌지 않음

### 타임 스탬프

41비트를 차지한다.

시간의 흐름에 따라 점점 큰 값을 가지게 된다.

→ ID를 시간 순으로 정렬할 수 있음

**41비트로 표현할 수 있는 시간의 최대는 대략 69년**

→ 69년이 지나면 체계를 바꿔야 한다.

### 일련번호

일련번호는 12비트 → 2^12 → 4096개 표현 가능

밀리초가 1 지날때 마다 0으로 초기화하므로 1 밀리초 사이에 4096개 이상으로 생성되지 않으면 문제가 발생하지는 않음

## 마무리

---

추가적인 논의 사항

- 시계 동기화: ID 생성 서버들이 다른 시계를 사용할 수 있다. 이럴 때 시계 동기화가 필요하다. → NTP(Network Time Protocol)을 활용하여 해결 가능하다.
- 각 section의 길이 최적화: 동시성이 낮고 수명이 긴 Application의 경우 일련 번호를 줄이고 타임 스탬프를 늘릴 수 있다.
- 고가용성: ID 생성기는 필수 불가결 컴포넌트이므로 매우 높은 가용성이 필요함
